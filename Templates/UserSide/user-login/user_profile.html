{% extends "UserSide/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    <img src="https://via.placeholder.com/150" class="rounded-circle mb-3 img-fluid" alt="Profile Picture">
                    <h5 class="card-title">{{ user.first_name }} {{ user.last_name }}</h5>
                    <p class="card-text text-muted">{{ user.email }}</p>
                    <p class="card-text"><small class="text-muted">{{ user.created_at }}</small></p>
                    <a href="#" class="genric-btn primary-border small">Logout</a>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a class="nav-link" href="#orders">
                            <i class="bi bi-bag"></i> My Orders
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a class="nav-link" href="#add-address">
                            <i class="bi bi-geo-alt"></i> Add Address
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <!-- User Info -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">User Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-3"><strong>Name:</strong></div>
                        <div class="col-sm-9">{{ user.first_name }} {{ user.last_name }}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-3"><strong>Email:</strong></div>
                        <div class="col-sm-9">{{ user.email }}</div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm-3"><strong>Date Joined:</strong></div>
                        <div class="col-sm-9">{{ user.date_joined }}</div>
                    </div>
                </div>
            </div>

            <!-- Add New Address -->
            <button class="genric-btn info-border circle arrow btn-primary mb-4" type="button" data-bs-toggle="collapse" data-bs-target="#add-address-form" aria-expanded="false" aria-controls="add-address-form">
                Add New Address <span class="lnr lnr-arrow-right"></span>
            </button>

            <!-- Collapsible form -->
            <div class="collapse" id="add-address-form">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Add New Address</h5>
                    </div>
                    <div class="card-body">
                        <form action="{% url 'add_address' %}" method="post">
                            {% csrf_token %}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" name="name" class="form-control" placeholder="Full Name" required>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" name="house_name" class="form-control" placeholder="House Name" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" name="street_name" class="form-control" placeholder="Street Address" required>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" name="district" class="form-control" placeholder="District" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" name="state" class="form-control" placeholder="State/Province" required>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" name="pin_number" class="form-control" placeholder="Zip/Postal Code" required>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" name="phone_number" class="form-control" placeholder="Phone Number" required>
                                </div>
                            </div>
                            <button type="submit" class="genric-btn success-border circle">
                                Add New Address
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Address List -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Your Addresses</h5>
                </div>
                <div class="card-body">
                    {% for a in addresses %}
                        <div class="address-card mb-3 p-3 border rounded">
                            <h6>{{ a.name }}</h6>
                            <p class="mb-2">
                                Address: {{ a.house_name }}, {{ a.street_name }}, Pin: {{ a.pin_number }}<br>
                                District: {{ a.district }}, State: {{ a.state }}<br>
                                Phone: {{ a.phone_number }}
                            </p>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleEditForm({{ a.id }})">Edit</button>
                            <!-- Delete Button -->
                            <form method="POST" action="{% url 'delete_address' a.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>

                            <div id="edit-form-{{ a.id }}" class="edit-form mt-3" style="display: none;">
                                <form method="POST" action="{% url 'edit_address' a.id %}">
                                    {% csrf_token %}
                                    <div class="form-group mb-3">
                                        <label for="name-{{ a.id }}">Name</label>
                                        <input type="text" class="form-control" name="name" id="name-{{ a.id }}" value="{{ a.name }}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="house_name-{{ a.id }}">House Name</label>
                                        <input type="text" class="form-control" name="house_name" id="house_name-{{ a.id }}" value="{{ a.house_name }}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="street_name-{{ a.id }}">Street Name</label>
                                        <input type="text" class="form-control" name="street_name" id="street_name-{{ a.id }}" value="{{ a.street_name }}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="pin_number-{{ a.id }}">Pin Number</label>
                                        <input type="text" class="form-control" name="pin_number" id="pin_number-{{ a.id }}" value="{{ a.pin_number }}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="district-{{ a.id }}">District</label>
                                        <input type="text" class="form-control" name="district" id="district-{{ a.id }}" value="{{ a.district }}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="state-{{ a.id }}">State</label>
                                        <input type="text" class="form-control" name="state" id="state-{{ a.id }}" value="{{ a.state }}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="phone_number-{{ a.id }}">Phone Number</label>
                                        <input type="text" class="form-control" name="phone_number" id="phone_number-{{ a.id }}" value="{{ a.phone_number }}" required>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input type="checkbox" class="form-check-input" name="set_as_primary" id="set_as_primary-{{ a.id }}" {% if a.status %}checked{% endif %}>
                                        <label for="set_as_primary-{{ a.id }}" class="form-check-label">Set as Primary Address</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Bootstrap JS Bundle with Popper.js -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

            <!-- SweetAlert for messages -->
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <script>
                document.addEventListener('DOMContentLoaded', (event) => {
                    {% if messages %}
                        const messages = [
                            {% for message in messages %}
                                {
                                    level: "{{ message.tags }}",
                                    text: "{{ message }}"
                                },
                            {% endfor %}
                        ];
                        messages.forEach(message => {
                            Swal.fire({
                                toast: true,
                                position: 'top-right',
                                icon: message.level === 'success' ? 'success' : 'error',
                                title: message.text,
                                showConfirmButton: false,
                                timer: 3000
                            });
                        });
                    {% endif %}
                });

                function toggleEditForm(addressId) {
                    var form = document.getElementById('edit-form-' + addressId);
                    form.style.display = form.style.display === 'none' ? 'block' : 'none';
                }
            </script>
        </div>
    </div>
</div>
{% endblock %}
