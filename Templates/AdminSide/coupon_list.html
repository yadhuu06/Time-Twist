{% extends 'AdminSide/base.html' %}
{% load static %}

{% block content %}
<div class="content">
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 style="color: #ecf0f1;">Existing Coupons</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#couponModal">Add New Coupon</button>
    </div>

    <!-- Coupon List -->
    <div id="couponList">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Discount</th>
                    <th>Min Amount</th>
                    <th>Max Amount</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="couponTableBody">
                {% for coupon in coupons %}
                <tr id="coupon-{{ coupon.id }}">
                    <td>{{ coupon.coupon_code }}</td>
                    <td>{{ coupon.coupon_name }}</td>
                    <td>{{ coupon.discount }} %</td>
                    <td>{{ coupon.minimum_amount }}</td>
                    <td>{{ coupon.maximum_amount }}</td>
                    <td>{{ coupon.expiry_date|date:"Y-m-d" }}</td>
                    <td>
                        <span class="badge {% if coupon.status %}bg-success{% else %}bg-danger{% endif %}">
                            {{ coupon.status|yesno:"Active,Inactive" }}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-coupon" data-id="{{ coupon.id }}">Edit</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Coupon Modal -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formTitle">Add New Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="couponForm">
                    {% csrf_token %}
                    <input type="hidden" id="couponId" name="couponId">
                    <div class="mb-3">
                        <label for="coupon_name" class="form-label">Coupon Name</label>
                        <input type="text" class="form-control" id="coupon_name" name="coupon_name" required pattern="^\S.*$">
                    </div>
                    <div class="mb-3">
                        <label for="coupon_code" class="form-label">Coupon Code</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="coupon_code" name="coupon_code" required pattern="^\S.*$">
                            <button class="btn btn-outline-secondary" type="button" id="generateCouponCode">Generate</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="discount" class="form-label">Discount (%)</label>
                        <input type="number" class="form-control" id="discount" name="discount" required min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label for="minimum_amount" class="form-label">Minimum Amount</label>
                        <input type="number" class="form-control" id="minimum_amount" name="minimum_amount" required min="0">
                    </div>
                    <div class="mb-3">
                        <label for="maximum_amount" class="form-label">Maximum Amount</label>
                        <input type="number" class="form-control" id="maximum_amount" name="maximum_amount" required min="501">
                    </div>
                    <div class="mb-3">
                        <label for="expiry_date" class="form-label">Expiry Date</label>
                        <input type="date" class="form-control" id="expiry_date" name="expiry_date" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="status" name="status">
                        <label class="form-check-label" for="status">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCouponBtn">Save Coupon</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    function setMinDate() {
        var today = new Date().toISOString().split('T')[0];
        $('#expiry_date').attr('min', today);
    }

    setMinDate();

    $('#generateCouponCode').click(function() {
        $.ajax({
            url: '{% url "generate_coupon_code" %}',
            type: 'GET',
            success: function(response) {
                $('#coupon_code').val(response.coupon_code);
            },
            error: function() {
                alert('Error generating coupon code');
            }
        });
    });

    $('#saveCouponBtn').click(function() {
        var formData = new FormData($('#couponForm')[0]);
        var couponId = $('#couponId').val();
        var url = couponId ? `{% url 'coupon_update' 0 %}`.replace('0', couponId) : '{% url "coupon_create" %}';

        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (couponId) {
                    updateCouponRow(response);
                } else {
                    addCouponRow(response);
                }
                $('#couponModal').modal('hide');
                $('#couponForm')[0].reset();
            },
            error: function(xhr) {
                alert('Error saving coupon: ' + JSON.stringify(xhr.responseJSON.errors));
            }
        });
    });

    $(document).on('click', '.edit-coupon', function() {
        var couponId = $(this).data('id');
        var row = $(`#coupon-${couponId}`);
        $('#couponId').val(couponId);
        $('#coupon_name').val(row.find('td:eq(1)').text().trim());
        $('#coupon_code').val(row.find('td:eq(0)').text().trim());
        $('#discount').val(parseFloat(row.find('td:eq(2)').text()));
        $('#minimum_amount').val(row.find('td:eq(3)').text().trim());
        $('#maximum_amount').val(row.find('td:eq(4)').text().trim());
        $('#expiry_date').val(row.find('td:eq(5)').text().trim());
        $('#status').prop('checked', row.find('td:eq(6) .badge').hasClass('bg-success'));
        $('#formTitle').text('Edit Coupon');
        $('#couponModal').modal('show');
    });

    function addCouponRow(coupon) {
        var newRow = `
            <tr id="coupon-${coupon.id}">
                <td>${coupon.coupon_code}</td>
                <td>${coupon.coupon_name}</td>
                <td>${coupon.discount} %</td>
                <td>${coupon.minimum_amount}</td>
                <td>${coupon.maximum_amount}</td>
                <td>${coupon.expiry_date}</td>
                <td>
                    <span class="badge ${coupon.status ? 'bg-success' : 'bg-danger'}">
                        ${coupon.status ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary edit-coupon" data-id="${coupon.id}">Edit</button>
                </td>
            </tr>
        `;
        $('#couponTableBody').append(newRow);
    }

    function updateCouponRow(coupon) {
        var row = $(`#coupon-${coupon.id}`);
        row.find('td:eq(0)').text(coupon.coupon_code);
        row.find('td:eq(1)').text(coupon.coupon_name);
        row.find('td:eq(2)').text(coupon.discount + ' %');
        row.find('td:eq(3)').text(coupon.minimum_amount);
        row.find('td:eq(4)').text(coupon.maximum_amount);
        row.find('td:eq(5)').text(coupon.expiry_date);
        row.find('td:eq(6)').html(`
            <span class="badge ${coupon.status ? 'bg-success' : 'bg-danger'}">
                ${coupon.status ? 'Active' : 'Inactive'}
            </span>
        `);
    }
});
</script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

<style>
    body {
        background: linear-gradient(135deg, #0d0d25 0%, #1a1a40 50%, #2c2c54 100%);
        font-family: 'Arial', sans-serif;
        color: #ffffff;
       
    }
    
    .container {
        max-width: 95%;
    }
    
    h2 {
        font-family: 'Cinzel', serif;
        font-size: 1.8rem;
        margin-bottom: 1rem;
    }
    
    .table {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table thead {
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .table th, .table td {
        border: none;
        padding: 0.75rem;
        vertical-align: middle;
        color: #ffffff;
    }
    
    .table tr {
        transition: background-color 0.3s ease;
    }
    
    .table tr:hover {
        background: linear-gradient(135deg, #0d0d25 0%, #1a1a40 50%, #2c2c54 100%);
    }
    
    .btn-primary {
        background-color: rgba(0, 123, 255, 0.7);
        border-color: rgba(0, 123, 255, 0.7);
    }
    
    .btn-primary:hover {
        background-color: rgba(0, 86, 179, 0.9);
        border-color: rgba(0, 86, 179, 0.9);
    }
    
    .modal-content {
        background-color: rgba(26, 26, 46, 0.9);
        border-radius: 10px;
    }
    
    .form-control {
        background-color: rgba(42, 42, 62, 0.7);
        color: #ffffff;
        border: 1px solid rgba(58, 58, 78, 0.7);
        border-radius: 5px;
    }
    
    .form-control:focus {
        background-color: rgba(58, 58, 78, 0.9);
        color: #ffffff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-control::placeholder {
        color: rgba(138, 138, 158, 0.7);
    }
    
    .modal-body label {
        color: #ffffff;
    }
    
    .badge {
        font-size: 0.85rem;
        padding: 0.35em 0.65em;
    }
    
    @media (max-width: 768px) {
        .table {
            font-size: 0.9rem;
        }
        
        .btn-sm {
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
        }
    }
</style>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        {% if messages %}
            const messages = [
                {% for message in messages %}
                    {
                        level: "{{ message.tags }}",
                        text: "{{ message }}"
                    },
                {% endfor %}
            ];
            messages.forEach(message => {
                Swal.fire({
                    toast: true,
                    position: 'top-right',
                    icon: message.level === 'success' ? 'success' : 'error',
                    title: message.text,
                    showConfirmButton: false,
                    timer: 3000
                });
            });
        {% endif %}
    });
</script>
{% endblock %}