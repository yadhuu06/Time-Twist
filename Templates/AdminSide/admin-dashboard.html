{% extends "AdminSide/base.html" %}

{% block title %}TimeTwist - Dashboard{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-dark text-light">
    <div class="container-fluid">
        <main class="px-md-4 w-100">
            <!-- Page header -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h1 text-light">Admin Dashboard</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <select id="timeRange" class="form-select form-select-sm bg-dark text-light" onchange="updateDashboard()">
                        <option value="weekly" {% if time_range == 'weekly' %}selected{% endif %}>Last 7 days</option>
                        <option value="monthly" {% if time_range == 'monthly' %}selected{% endif %}>Last 30 days</option>
                        <option value="yearly" {% if time_range == 'yearly' %}selected{% endif %}>Last 365 days</option>
                    </select>
                </div>
            </div>

            <!-- Cards -->
            <div class="row row-cols-1 row-cols-md-3 row-cols-xl-4 g-3 mb-3">
                <div class="col">
                    <div class="card bg-dark text-light h-100 border border-secondary">
                        <div class="card-body text-center">
                            <h6 class="card-title text-uppercase">Total Orders</h6>
                            <p class="card-text display-5">{{ total_orders }}</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card bg-dark text-light h-100 border border-secondary">
                        <div class="card-body text-center">
                            <h6 class="card-title text-uppercase">Pending Orders</h6>
                            <p class="card-text display-5">{{ pending_orders }}</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card bg-dark text-light h-100 border border-secondary">
                        <div class="card-body text-center">
                            <h6 class="card-title text-uppercase">Completed Orders</h6>
                            <p class="card-text display-5">{{ completed_orders }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="card bg-dark text-light border border-secondary">
                        <div class="card-body">
                            <h6 class="card-title text-uppercase">Order Trends</h6>
                            <canvas id="orderTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark text-light border border-secondary">
                        <div class="card-body">
                            <h6 class="card-title text-uppercase">Order Status</h6>
                            <canvas id="orderStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Products and Variants -->
            <div class="row g-3 mt-3">
                <div class="col-md-6">
                    <div class="card bg-dark text-light border border-secondary">
                        <div class="card-body">
                            <h6 class="card-title text-uppercase">Top 5 Selling Products</h6>
                            <ul class="list-group list-group-flush">
                                {% for product in top_products %}
                                    <li class="list-group-item bg-dark text-light">
                                        {{ product.product_variant__product__product_name }} -
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-dark text-light border border-secondary">
                        <div class="card-body">
                            <h6 class="card-title text-uppercase">Top 5 Selling Variants</h6>
                            <ul class="list-group list-group-flush">
                                {% for variant in top_variants %}
                                    <li class="list-group-item bg-dark text-light">
                                        {{ variant.product_variant__variant_name }} - {{ variant.total_quantity }} sold
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript for Charts -->
    <script>
        // Django variables passed to JavaScript
        const dates = {{ dates|safe }};
        const ordersData = {{ orders_data|safe }};
        const revenueData = {{ revenue_data|safe }};
        const orderStatuses = {{ order_status_data|safe }};

        // Order Trends Chart
        const orderTrendsCtx = document.getElementById('orderTrendsChart').getContext('2d');
        const orderTrendsChart = new Chart(orderTrendsCtx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Orders',
                    data: ordersData,
                    borderColor: '#4dc9f6',
                    backgroundColor: 'rgba(77, 201, 246, 0.1)',
                    tension: 0.1,
                    fill: true
                }, {
                    label: 'Revenue',
                    data: revenueData,
                    borderColor: '#ff6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#e0e0e0'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#333'
                        },
                        ticks: {
                            color: '#e0e0e0'
                        }
                    },
                    x: {
                        grid: {
                            color: '#333'
                        },
                        ticks: {
                            color: '#e0e0e0'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // Order Status Chart
        const orderStatusCtx = document.getElementById('orderStatusChart').getContext('2d');
        const orderStatusChart = new Chart(orderStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'Processing', 'Shipped', 'Delivered'],
                datasets: [{
                    data: orderStatuses,
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e0e0e0'
                        }
                    }
                }
            }
        });

        function updateDashboard() {
            const timeRange = document.getElementById('timeRange').value;
            window.location.href = `?time_range=${timeRange}`;
        }
    </script>
</body>
{% endblock %}